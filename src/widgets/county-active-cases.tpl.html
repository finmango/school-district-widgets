<!-- Chart dependencies -->
<script src="../templates/chart-deps.tpl.html" data-include data-vars='{"root": "{{root}}"}'></script>

<!-- Wrap the whole widget into a DIV -->
<div>
    <script async>
        (async function () {
            async function findLocationKey() {
                const districtId = new URLSearchParams(location.search).get('district_id');
                const metadata = await loadCSV(`${CURRENT_OPTIONS['tcm-metadata-url']}`);
                const districtMetadata = metadata.filter(row => row.district_id === districtId)[0];
                const zipIndex = await loadCSV('{{root}}/static/zip-fips-map.csv');
                const fips = zipIndex.filter(row => row.zip === districtMetadata.zip_code)[0].fips;
                return `US_${districtMetadata.state}_${fips}`;
            }

            // Human-friendly label for a symptom
            const symptomLabel = column => column.split('_').slice(2).join(' ');

            // Create a new element to hold the chart and add it to the page
            const elem = document.createElement('div');
            document.currentScript.parentElement.append(elem);

            // Get the location key from the district metadata
            const locationKey = await findLocationKey();

            // Load the location data using the location key
            const locationData = await loadCSV(`${CURRENT_OPTIONS['cod-data-url']}/${locationKey}/main.csv`);

            // Get the name of the location from the location data
            const locationName = locationData[0].subregion2_name;

            // Put the confirmed cases from the state data into a table and draw it in the chart
            const rollingWindowSize = 14;
            const data = locationData.map((row, idx) => {
                const start = Math.max(0, idx - rollingWindowSize);
                const rollingSum = locationData.slice(start, idx)
                    .reduce((total, row) => total + (parseInt(row.new_confirmed) || 0), 0);
                return { ['Date']: row.date, ['Cases']: rollingSum };
            })

            await loadGoogleCharts(['corechart']);
            const chartObject = new google.visualization.ColumnChart(elem);
            chartObject.draw(recordsToDataTable(data), {
                title: `Estimated active cases in ${locationName}`,
                theme: 'material',
                colors: ['#FF9800'],
                legend: { position: 'none' },
                chartArea: { width: '100%', height: '100%', left: 12, bottom: 48 },
                titlePosition: 'in', axisTitlesPosition: 'in',
                hAxis: { textPosition: 'bottom' }, vAxis: { textPosition: 'in', viewWindow: { min: 0 } },
                height: 300,
            });
        })();
    </script>
</div>